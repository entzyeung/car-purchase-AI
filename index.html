<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Purchase AI</title>

    <!-- PyScript Library -->
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

    <!-- Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        h1, h2, h3 {
            text-align: center;
        }
        .container {
            width: 80%;
            margin: auto;
        }
        .output {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>

    <py-env>
        - pandas==1.5.3
        - scikit-learn==1.2.2
        - numpy==1.24.2
    </py-env>
</head>
<body>

    <h1>AI Recommendation for Car Deals</h1>
    <div class="container">
        <h2>Train Your Model</h2>
        <form id="train-form">
            <label for="test_split">Test Split (0.1 - 0.5):</label>
            <input type="number" id="test_split" min="0.1" max="0.5" step="0.1" value="0.25" required />
            <br><br>
            <label for="model_type">Select Model:</label>
            <select id="model_type">
                <option value="logistic">Logistic Regression</option>
                <option value="gradient">Gradient Boosting</option>
            </select>
            <br><br>
            <button type="button" id="trainModelBtn">Train Model</button>
        </form>
        
        <div class="output" id="training-output">
            <h3>Training Results</h3>
            <p id="training-status">No training done yet.</p>
        </div>

        <h2>Get AI Recommendation</h2>
        <form id="ai-form">
            <label for="buying_price">Buying Price:</label>
            <select id="buying_price">
                <option value="3">Very High (15,000£+)</option>
                <option value="2">High (10,000£)</option>
                <option value="1">Medium (7,500£)</option>
                <option value="0">Low (5,000£)</option>
            </select>
            <br><br>
            <label for="maintenance_price">Maintenance Price:</label>
            <select id="maintenance_price">
                <option value="3">Very High</option>
                <option value="2">High</option>
                <option value="1">Medium</option>
                <option value="0">Low</option>
            </select>
            <br><br>
            <label for="safety">Safety Features:</label>
            <select id="safety">
                <option value="0">No Air Bags</option>
                <option value="1">Front Air Bags</option>
                <option value="2">Front & Back Air Bags</option>
            </select>
            <br><br>
            <button type="button" id="submitBtn" disabled>Get Recommendation</button>
        </form>

        <div class="output" id="ai-output">
            <h3>AI Recommendation</h3>
            <p id="ai-result">No recommendation yet.</p>
        </div>
    </div>

    <py-script>
        import pandas as pd
        import numpy as np
        from sklearn.model_selection import train_test_split
        from sklearn.linear_model import LogisticRegression
        from sklearn.ensemble import GradientBoostingClassifier
        from sklearn.metrics import accuracy_score, f1_score

        # Global variable to hold the trained model
        trained_model = None

        def preprocess_data():
            """Load and preprocess the dataset."""
            url = "https://raw.githubusercontent.com/entzyeung/car-purchase-ai/main/car.csv"
            data = pd.read_csv(url)

            # Data cleaning and encoding
            data = data.drop_duplicates()
            data = data.fillna(0)

            data['buying'] = data['buying'].map({'low': 0, 'med': 1, 'high': 2, 'vhigh': 3})
            data['maint'] = data['maint'].map({'low': 0, 'med': 1, 'high': 2, 'vhigh': 3})
            data['doors'] = data['doors'].map({'2': 0, '3': 1, '4': 2, '5more': 3})
            data['people'] = data['people'].map({'2': 0, '4': 1, 'more': 2})
            data['lug_boot'] = data['lug_boot'].map({'small': 0, 'med': 1, 'big': 2})
            data['safety'] = data['safety'].map({'low': 0, 'med': 1, 'high': 2})
            data['score'] = data['score'].map({'unacc': 0, 'acc': 1, 'good': 2, 'vgood': 3})

            return data

        def train_model(event=None):
            """Train the model based on user input."""
            global trained_model
            data = preprocess_data()

            X = data[['buying', 'maint', 'doors', 'people', 'lug_boot', 'safety']]
            y = data['score']

            test_size = float(document.querySelector("#test_split").value)
            model_type = document.querySelector("#model_type").value

            X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=test_size, random_state=42)

            # Choose the model
            if model_type == "logistic":
                model = LogisticRegression()
            else:
                model = GradientBoostingClassifier()

            model.fit(X_train, y_train)
            y_pred = model.predict(X_test)

            acc = accuracy_score(y_test, y_pred)
            f1 = f1_score(y_test, y_pred, average='weighted')

            trained_model = model

            # Update DOM with results
            document.querySelector("#training-status").innerText = (
                f"Training complete! Accuracy: {acc:.2f}, F1 Score: {f1:.2f}"
            )
            document.querySelector("#submitBtn").disabled = False

        def get_recommendation(event=None):
            """Get AI recommendation based on input features."""
            global trained_model
            if not trained_model:
                document.querySelector("#ai-result").innerText = "Train the model first!"
                return

            # Collect inputs
            features = [
                int(document.querySelector("#buying_price").value),
                int(document.querySelector("#maintenance_price").value),
                0,  # Dummy value for doors
                0,  # Dummy value for persons
                0,  # Dummy value for luggage
                int(document.querySelector("#safety").value),
            ]

            prediction = trained_model.predict([features])[0]
            conditions = ["Unacceptable", "Acceptable", "Good", "Very Good"]
            document.querySelector("#ai-result").innerText = f"Recommendation: {conditions[prediction]}"

        # Link buttons to functions
        document.querySelector("#trainModelBtn").addEventListener("click", train_model)
        document.querySelector("#submitBtn").addEventListener("click", get_recommendation)
    </py-script>

</body>
</html>
